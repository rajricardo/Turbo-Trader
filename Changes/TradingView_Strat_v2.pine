//@version=5
strategy("Pro EMA Retest Strategy v2", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=50, pyramiding=2)

// ============================================================================
// SETTINGS
// ============================================================================

// Trend Filter Settings
trendFilterType = input.string("EMA Stack", "Trend Filter Method", options=["EMA Stack", "ORB Hybrid"], group="Trend Filter")

// EMA Settings
ema9Length = input.int(9, "Fast EMA Length", minval=1, group="EMA Settings")
ema20Length = input.int(20, "Slow EMA Length", minval=1, group="EMA Settings")

// ORB Settings (only used if ORB Hybrid selected)
orbPeriodMinutes = input.int(15, "ORB Period (minutes)", minval=5, maxval=60, step=5, group="ORB Settings")

// Scaling Settings
useScaleIn = input.bool(true, "Enable Scale In", group="Scaling")
useScaleOut = input.bool(true, "Enable Scale Out", group="Scaling")
scaleInPercent = input.float(50.0, "Scale In Size (% of initial)", minval=10, maxval=100, step=10, group="Scaling")
firstTargetRR = input.float(1.0, "First Target (R:R)", minval=0.5, maxval=3.0, step=0.5, group="Scaling")
secondTargetRR = input.float(2.0, "Second Target (R:R)", minval=1.0, maxval=5.0, step=0.5, group="Scaling")
useTrailingStop = input.bool(true, "Use Trailing Stop for Runner", group="Scaling")

// Risk Settings
maxReentries = input.int(1, "Max Re-entries After Stop", minval=0, maxval=3, group="Risk Management")

// Visual Settings
showLabels = input.bool(true, "Show Entry/Exit Labels", group="Visuals")
showTargetLines = input.bool(true, "Show Stop/Target Lines", group="Visuals")
labelSize = input.string("normal", "Label Size", options=["tiny", "small", "normal", "large"], group="Visuals")

// Session Settings
sessionStart = input.session("0930-1530", "Trading Session (Entry Window)", group="Session")
sessionClose = input.session("0930-1600", "Full Session (Position Management)", group="Session")
timezone = input.string("America/New_York", "Timezone", group="Session")

// ============================================================================
// SESSION & TIME LOGIC
// ============================================================================
inEntrySession = not na(time(timeframe.period, sessionStart, timezone))
inFullSession = not na(time(timeframe.period, sessionClose, timezone))
sessionStartTime = timestamp(timezone, year, month, dayofmonth, 9, 30, 0)
orbEndTime = sessionStartTime + orbPeriodMinutes * 60 * 1000
currentTime = time
pastORBPeriod = currentTime >= orbEndTime
newSession = inFullSession and not inFullSession[1]

// ============================================================================
// INDICATORS
// ============================================================================
ema9 = ta.ema(close, ema9Length)
ema20 = ta.ema(close, ema20Length)
vwapValue = ta.vwap(close)

// EMA Slope (for momentum confirmation)
ema9Slope = ema9 - ema9[3]
ema20Slope = ema20 - ema20[3]

// Plot indicators
plot(ema9, "Fast EMA", color=color.blue, linewidth=2)
plot(ema20, "Slow EMA", color=color.red, linewidth=2)
plot(vwapValue, "VWAP", color=color.orange, linewidth=2, style=plot.style_circles)

// ============================================================================
// OPENING RANGE BREAKOUT LOGIC
// ============================================================================
var float orbHigh = na
var float orbLow = na
var bool orbCaptured = false

// Reset ORB at session start
if newSession
    orbHigh := high
    orbLow := low
    orbCaptured := false

// Build ORB during the opening period
if inFullSession and not pastORBPeriod
    orbHigh := math.max(nz(orbHigh, high), high)
    orbLow := math.min(nz(orbLow, low), low)

// Mark ORB as captured once period ends
if pastORBPeriod and not pastORBPeriod[1]
    orbCaptured := true

// Plot ORB levels
plot(orbCaptured and trendFilterType == "ORB Hybrid" ? orbHigh : na, "ORB High", color=color.green, linewidth=1, style=plot.style_linebr)
plot(orbCaptured and trendFilterType == "ORB Hybrid" ? orbLow : na, "ORB Low", color=color.red, linewidth=1, style=plot.style_linebr)

// ============================================================================
// TREND FILTER LOGIC
// ============================================================================
// EMA Stack Method: 9 EMA > 20 EMA > VWAP for bullish (inverse for bearish)
emaStackBullish = ema9 > ema20 and ema20 > vwapValue and ema9Slope > 0
emaStackBearish = ema9 < ema20 and ema20 < vwapValue and ema9Slope < 0

// ORB Hybrid Method: Price above ORB High + EMA confirmation for bullish
orbHybridBullish = orbCaptured and close > orbHigh and ema9 > ema20 and close > vwapValue
orbHybridBearish = orbCaptured and close < orbLow and ema9 < ema20 and close < vwapValue

// Combined trend bias based on selected method
bullishBias = trendFilterType == "EMA Stack" ? emaStackBullish : orbHybridBullish
bearishBias = trendFilterType == "EMA Stack" ? emaStackBearish : orbHybridBearish

// ============================================================================
// RETEST DETECTION LOGIC
// ============================================================================
// Bullish Retest: Price pulls back to touch EMA9 or EMA20, holds, closes above
// Must have wick below EMA but close above (shows rejection/support)
bullishRetestEMA9 = low <= ema9 and close > ema9 and close > open  // Bullish candle holding EMA9
bullishRetestEMA20 = low <= ema20 and close > ema20 and close > ema9  // Deeper pullback to EMA20
bullishRetestVWAP = low <= vwapValue and close > vwapValue and close > ema20  // VWAP support

bullishRetest = bullishRetestEMA9 or bullishRetestEMA20 or bullishRetestVWAP

// Bearish Retest: Price bounces to touch EMA9 or EMA20, rejected, closes below
bearishRetestEMA9 = high >= ema9 and close < ema9 and close < open  // Bearish candle rejected at EMA9
bearishRetestEMA20 = high >= ema20 and close < ema20 and close < ema9  // Rejection at EMA20
bearishRetestVWAP = high >= vwapValue and close < vwapValue and close < ema20  // VWAP resistance

bearishRetest = bearishRetestEMA9 or bearishRetestEMA20 or bearishRetestVWAP

// ============================================================================
// ENTRY TRACKING VARIABLES
// ============================================================================
var float longEntryPrice = na
var float longStopLevel = na
var float shortEntryPrice = na
var float shortStopLevel = na
var int longReentryCount = 0
var int shortReentryCount = 0
var bool longScaledIn = false
var bool shortScaledIn = false
var bool longFirstTargetHit = false
var bool shortFirstTargetHit = false
var string longEntryEMA = ""
var string shortEntryEMA = ""

// Reset counters at session start
if newSession
    longReentryCount := 0
    shortReentryCount := 0
    longScaledIn := false
    shortScaledIn := false
    longFirstTargetHit := false
    shortFirstTargetHit := false
    longEntryEMA := ""
    shortEntryEMA := ""
    longEntryPrice := na
    longStopLevel := na
    shortEntryPrice := na
    shortStopLevel := na

// ============================================================================
// STOP LEVEL CALCULATION
// ============================================================================
// Determine which EMA was used for entry and set stop accordingly
getLongStopLevel() =>
    if bullishRetestEMA9
        ema9
    else if bullishRetestEMA20
        ema20
    else
        vwapValue

getShortStopLevel() =>
    if bearishRetestEMA9
        ema9
    else if bearishRetestEMA20
        ema20
    else
        vwapValue

// ============================================================================
// ENTRY CONDITIONS
// ============================================================================
// Long Entry
longCondition = bullishBias and bullishRetest and inEntrySession and pastORBPeriod and strategy.position_size == 0 and longReentryCount <= maxReentries

// Short Entry  
shortCondition = bearishBias and bearishRetest and inEntrySession and pastORBPeriod and strategy.position_size == 0 and shortReentryCount <= maxReentries

// Scale In Conditions (successful retest while in position)
longScaleInCondition = useScaleIn and strategy.position_size > 0 and not longScaledIn and bullishRetest and close > longEntryPrice
shortScaleInCondition = useScaleIn and strategy.position_size < 0 and not shortScaledIn and bearishRetest and close < shortEntryPrice

// ============================================================================
// EXIT CONDITIONS
// ============================================================================
// Stop Loss: Close below/above the EMA used for entry
longStopHit = strategy.position_size > 0 and close < longStopLevel
shortStopHit = strategy.position_size < 0 and close > shortStopLevel

// Profit Targets
longRisk = strategy.position_size > 0 ? longEntryPrice - longStopLevel : na
shortRisk = strategy.position_size < 0 ? shortStopLevel - shortEntryPrice : na

longFirstTarget = strategy.position_size > 0 ? longEntryPrice + (longRisk * firstTargetRR) : na
longSecondTarget = strategy.position_size > 0 ? longEntryPrice + (longRisk * secondTargetRR) : na
shortFirstTarget = strategy.position_size < 0 ? shortEntryPrice - (shortRisk * firstTargetRR) : na
shortSecondTarget = strategy.position_size < 0 ? shortEntryPrice - (shortRisk * secondTargetRR) : na

longFirstTargetReached = strategy.position_size > 0 and high >= longFirstTarget and not longFirstTargetHit
shortFirstTargetReached = strategy.position_size < 0 and low <= shortFirstTarget and not shortFirstTargetHit

longSecondTargetReached = strategy.position_size > 0 and high >= longSecondTarget
shortSecondTargetReached = strategy.position_size < 0 and low <= shortSecondTarget

// Trailing Stop (for runner after first target)
var float trailingStopLong = na
var float trailingStopShort = na

if strategy.position_size > 0 and longFirstTargetHit and useTrailingStop
    trailingStopLong := math.max(nz(trailingStopLong, longEntryPrice), ema9)
    
if strategy.position_size < 0 and shortFirstTargetHit and useTrailingStop
    trailingStopShort := math.min(nz(trailingStopShort, shortEntryPrice), ema9)

trailingStopLongHit = strategy.position_size > 0 and longFirstTargetHit and useTrailingStop and close < trailingStopLong
trailingStopShortHit = strategy.position_size < 0 and shortFirstTargetHit and useTrailingStop and close > trailingStopShort

// ============================================================================
// RE-ENTRY LOGIC
// ============================================================================
// Track if price reclaims EMA after stop out
var bool longStoppedOut = false
var bool shortStoppedOut = false

if longStopHit
    longStoppedOut := true
if shortStopHit
    shortStoppedOut := true

// Re-entry allowed if price reclaims the EMA
longReentrySignal = longStoppedOut and bullishBias and close > ema9 and close > ema20 and inEntrySession and longReentryCount < maxReentries
shortReentrySignal = shortStoppedOut and bearishBias and close < ema9 and close < ema20 and inEntrySession and shortReentryCount < maxReentries

if longReentrySignal and bullishRetest
    longStoppedOut := false
if shortReentrySignal and bearishRetest
    shortStoppedOut := false

// ============================================================================
// HELPER FUNCTION FOR LABEL SIZE
// ============================================================================
getLabelSize() =>
    switch labelSize
        "tiny" => size.tiny
        "small" => size.small
        "normal" => size.normal
        "large" => size.large
        => size.normal

// ============================================================================
// STRATEGY EXECUTION WITH ENHANCED VISUALS
// ============================================================================

// === LONG ENTRIES ===
if longCondition
    longEntryPrice := close
    longStopLevel := getLongStopLevel()
    longEntryEMA := bullishRetestEMA9 ? "EMA9" : bullishRetestEMA20 ? "EMA20" : "VWAP"
    trailingStopLong := na
    longFirstTargetHit := false
    longScaledIn := false
    strategy.entry("Long", strategy.long, comment="Long Entry (" + longEntryEMA + ")")
    
    // Enhanced Entry Label
    if showLabels
        label.new(bar_index, low, "üü¢ BUY LONG\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nEntry: " + str.tostring(close, "#.##") + "\nStop: " + str.tostring(longStopLevel, "#.##") + "\nBasis: " + longEntryEMA, 
             style=label.style_label_up, color=color.green, textcolor=color.white, size=getLabelSize())
    
    // Draw entry arrow
    label.new(bar_index, low - (high - low) * 0.5, "‚ñ≤", style=label.style_none, textcolor=color.green, size=size.large)

// Long Scale In
if longScaleInCondition
    strategy.entry("Long", strategy.long, qty=strategy.equity * (scaleInPercent / 100) / close, comment="Scale In")
    longScaledIn := true
    longStopLevel := math.max(longStopLevel, longEntryPrice)
    
    if showLabels
        label.new(bar_index, low, "‚ûï SCALE IN\nAdding to Long", style=label.style_label_up, color=color.teal, textcolor=color.white, size=getLabelSize())

// === SHORT ENTRIES ===
if shortCondition
    shortEntryPrice := close
    shortStopLevel := getShortStopLevel()
    shortEntryEMA := bearishRetestEMA9 ? "EMA9" : bearishRetestEMA20 ? "EMA20" : "VWAP"
    trailingStopShort := na
    shortFirstTargetHit := false
    shortScaledIn := false
    strategy.entry("Short", strategy.short, comment="Short Entry (" + shortEntryEMA + ")")
    
    // Enhanced Entry Label
    if showLabels
        label.new(bar_index, high, "üî¥ SELL SHORT\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nEntry: " + str.tostring(close, "#.##") + "\nStop: " + str.tostring(shortStopLevel, "#.##") + "\nBasis: " + shortEntryEMA, 
             style=label.style_label_down, color=color.red, textcolor=color.white, size=getLabelSize())
    
    // Draw entry arrow
    label.new(bar_index, high + (high - low) * 0.5, "‚ñº", style=label.style_none, textcolor=color.red, size=size.large)

// Short Scale In
if shortScaleInCondition
    strategy.entry("Short", strategy.short, qty=strategy.equity * (scaleInPercent / 100) / close, comment="Scale In")
    shortScaledIn := true
    shortStopLevel := math.min(shortStopLevel, shortEntryPrice)
    
    if showLabels
        label.new(bar_index, high, "‚ûï SCALE IN\nAdding to Short", style=label.style_label_down, color=color.maroon, textcolor=color.white, size=getLabelSize())

// ============================================================================
// EXIT EXECUTION WITH ENHANCED VISUALS
// ============================================================================

// Long Stop Loss
if longStopHit and not longFirstTargetHit
    strategy.close("Long", comment="Stop Loss")
    longReentryCount += 1
    
    if showLabels
        lossAmount = longEntryPrice - close
        lossPercent = (lossAmount / longEntryPrice) * 100
        label.new(bar_index, high, "üõë STOP LOSS\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nExit: " + str.tostring(close, "#.##") + "\nLoss: -" + str.tostring(lossPercent, "#.##") + "%\nRe-entries: " + str.tostring(maxReentries - longReentryCount) + " left", 
             style=label.style_label_down, color=color.red, textcolor=color.white, size=getLabelSize())
        label.new(bar_index, high + (high - low) * 0.5, "‚úñ", style=label.style_none, textcolor=color.red, size=size.large)

// Long First Target (Scale Out 50%)
if longFirstTargetReached and useScaleOut
    strategy.close("Long", qty_percent=50, comment="Target 1 (" + str.tostring(firstTargetRR, "#.#") + "R)")
    longFirstTargetHit := true
    longStopLevel := longEntryPrice
    trailingStopLong := ema9
    
    if showLabels
        profitAmount = close - longEntryPrice
        profitPercent = (profitAmount / longEntryPrice) * 100
        label.new(bar_index, high, "üéØ TARGET 1 HIT\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nExit 50% @ " + str.tostring(close, "#.##") + "\nProfit: +" + str.tostring(profitPercent, "#.##") + "%\nStop ‚Üí Breakeven", 
             style=label.style_label_down, color=color.green, textcolor=color.white, size=getLabelSize())

// Long Second Target
if longSecondTargetReached and not useTrailingStop
    if showLabels
        profitAmount = close - longEntryPrice
        profitPercent = (profitAmount / longEntryPrice) * 100
        label.new(bar_index, high, "üéØüéØ TARGET 2 HIT\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nFull Exit @ " + str.tostring(close, "#.##") + "\nProfit: +" + str.tostring(profitPercent, "#.##") + "%", 
             style=label.style_label_down, color=color.lime, textcolor=color.black, size=getLabelSize())
    strategy.close("Long", comment="Target 2 (" + str.tostring(secondTargetRR, "#.#") + "R)")

// Long Trailing Stop
if trailingStopLongHit
    if showLabels
        profitAmount = close - longEntryPrice
        profitPercent = (profitAmount / longEntryPrice) * 100
        label.new(bar_index, high, "üî∂ TRAILING STOP\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nExit @ " + str.tostring(close, "#.##") + "\nProfit: +" + str.tostring(profitPercent, "#.##") + "%", 
             style=label.style_label_down, color=color.orange, textcolor=color.white, size=getLabelSize())
    strategy.close("Long", comment="Trailing Stop")

// Short Stop Loss
if shortStopHit and not shortFirstTargetHit
    strategy.close("Short", comment="Stop Loss")
    shortReentryCount += 1
    
    if showLabels
        lossAmount = close - shortEntryPrice
        lossPercent = (lossAmount / shortEntryPrice) * 100
        label.new(bar_index, low, "üõë STOP LOSS\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nExit: " + str.tostring(close, "#.##") + "\nLoss: -" + str.tostring(lossPercent, "#.##") + "%\nRe-entries: " + str.tostring(maxReentries - shortReentryCount) + " left", 
             style=label.style_label_up, color=color.red, textcolor=color.white, size=getLabelSize())
        label.new(bar_index, low - (high - low) * 0.5, "‚úñ", style=label.style_none, textcolor=color.red, size=size.large)

// Short First Target (Scale Out 50%)
if shortFirstTargetReached and useScaleOut
    strategy.close("Short", qty_percent=50, comment="Target 1 (" + str.tostring(firstTargetRR, "#.#") + "R)")
    shortFirstTargetHit := true
    shortStopLevel := shortEntryPrice
    trailingStopShort := ema9
    
    if showLabels
        profitAmount = shortEntryPrice - close
        profitPercent = (profitAmount / shortEntryPrice) * 100
        label.new(bar_index, low, "üéØ TARGET 1 HIT\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nExit 50% @ " + str.tostring(close, "#.##") + "\nProfit: +" + str.tostring(profitPercent, "#.##") + "%\nStop ‚Üí Breakeven", 
             style=label.style_label_up, color=color.green, textcolor=color.white, size=getLabelSize())

// Short Second Target
if shortSecondTargetReached and not useTrailingStop
    if showLabels
        profitAmount = shortEntryPrice - close
        profitPercent = (profitAmount / shortEntryPrice) * 100
        label.new(bar_index, low, "üéØüéØ TARGET 2 HIT\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nFull Exit @ " + str.tostring(close, "#.##") + "\nProfit: +" + str.tostring(profitPercent, "#.##") + "%", 
             style=label.style_label_up, color=color.lime, textcolor=color.black, size=getLabelSize())
    strategy.close("Short", comment="Target 2 (" + str.tostring(secondTargetRR, "#.#") + "R)")

// Short Trailing Stop
if trailingStopShortHit
    if showLabels
        profitAmount = shortEntryPrice - close
        profitPercent = (profitAmount / shortEntryPrice) * 100
        label.new(bar_index, low, "üî∂ TRAILING STOP\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nExit @ " + str.tostring(close, "#.##") + "\nProfit: +" + str.tostring(profitPercent, "#.##") + "%", 
             style=label.style_label_up, color=color.orange, textcolor=color.white, size=getLabelSize())
    strategy.close("Short", comment="Trailing Stop")

// End of Day Close
if not inFullSession and inFullSession[1]
    strategy.close_all(comment="EOD Close")
    if showLabels and strategy.position_size != 0
        label.new(bar_index, close, "üïê EOD CLOSE\nSession End", style=label.style_label_center, color=color.gray, textcolor=color.white, size=getLabelSize())

// ============================================================================
// PLOT SHAPES FOR QUICK VISUAL SCANNING
// ============================================================================
// Entry signals (triangles)
plotshape(longCondition, title="Long Entry Signal", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.normal)
plotshape(shortCondition, title="Short Entry Signal", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.normal)

// Exit signals (crosses and circles)
plotshape(longStopHit and not longFirstTargetHit, title="Long Stop", location=location.abovebar, color=color.red, style=shape.xcross, size=size.small)
plotshape(shortStopHit and not shortFirstTargetHit, title="Short Stop", location=location.belowbar, color=color.red, style=shape.xcross, size=size.small)

plotshape(longFirstTargetReached and useScaleOut, title="Long T1", location=location.abovebar, color=color.green, style=shape.circle, size=size.tiny)
plotshape(shortFirstTargetReached and useScaleOut, title="Short T1", location=location.belowbar, color=color.green, style=shape.circle, size=size.tiny)

plotshape(longSecondTargetReached and not useTrailingStop, title="Long T2", location=location.abovebar, color=color.lime, style=shape.diamond, size=size.small)
plotshape(shortSecondTargetReached and not useTrailingStop, title="Short T2", location=location.belowbar, color=color.lime, style=shape.diamond, size=size.small)

plotshape(trailingStopLongHit, title="Long Trail Exit", location=location.abovebar, color=color.orange, style=shape.square, size=size.small)
plotshape(trailingStopShortHit, title="Short Trail Exit", location=location.belowbar, color=color.orange, style=shape.square, size=size.small)

// Scale In signals
plotshape(longScaleInCondition, title="Long Scale In", location=location.belowbar, color=color.teal, style=shape.triangleup, size=size.tiny)
plotshape(shortScaleInCondition, title="Short Scale In", location=location.abovebar, color=color.maroon, style=shape.triangledown, size=size.tiny)

// ============================================================================
// VISUAL INDICATORS - STOP/TARGET LINES
// ============================================================================
// Background color for bias
bgColor = bullishBias ? color.new(color.green, 93) : bearishBias ? color.new(color.red, 93) : na
bgcolor(inFullSession ? bgColor : na, title="Trend Bias Background")

// Plot stop and target levels when in position
plot(showTargetLines and strategy.position_size > 0 ? longStopLevel : na, "Long Stop", color=color.red, linewidth=2, style=plot.style_linebr)
plot(showTargetLines and strategy.position_size > 0 ? longEntryPrice : na, "Long Entry", color=color.blue, linewidth=1, style=plot.style_linebr)
plot(showTargetLines and strategy.position_size > 0 ? longFirstTarget : na, "Long T1", color=color.green, linewidth=1, style=plot.style_linebr)
plot(showTargetLines and strategy.position_size > 0 and longFirstTargetHit ? longSecondTarget : na, "Long T2", color=color.lime, linewidth=1, style=plot.style_linebr)
plot(showTargetLines and strategy.position_size > 0 and longFirstTargetHit and useTrailingStop ? trailingStopLong : na, "Long Trail", color=color.orange, linewidth=2, style=plot.style_linebr)

plot(showTargetLines and strategy.position_size < 0 ? shortStopLevel : na, "Short Stop", color=color.red, linewidth=2, style=plot.style_linebr)
plot(showTargetLines and strategy.position_size < 0 ? shortEntryPrice : na, "Short Entry", color=color.blue, linewidth=1, style=plot.style_linebr)
plot(showTargetLines and strategy.position_size < 0 ? shortFirstTarget : na, "Short T1", color=color.green, linewidth=1, style=plot.style_linebr)
plot(showTargetLines and strategy.position_size < 0 and shortFirstTargetHit ? shortSecondTarget : na, "Short T2", color=color.lime, linewidth=1, style=plot.style_linebr)
plot(showTargetLines and strategy.position_size < 0 and shortFirstTargetHit and useTrailingStop ? trailingStopShort : na, "Short Trail", color=color.orange, linewidth=2, style=plot.style_linebr)

// ============================================================================
// INFO TABLE
// ============================================================================
var table infoTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Header
    table.cell(infoTable, 0, 0, "üìä STRATEGY STATUS", text_color=color.yellow, text_size=size.small, bgcolor=color.new(color.gray, 60))
    table.cell(infoTable, 1, 0, "", bgcolor=color.new(color.gray, 60))
    
    // Trend Filter
    table.cell(infoTable, 0, 1, "Filter:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, trendFilterType, text_color=color.yellow, text_size=size.small)
    
    // Current Bias
    biasText = bullishBias ? "üü¢ BULLISH" : bearishBias ? "üî¥ BEARISH" : "‚ö™ NEUTRAL"
    biasColor = bullishBias ? color.green : bearishBias ? color.red : color.gray
    table.cell(infoTable, 0, 2, "Bias:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, biasText, text_color=biasColor, text_size=size.small)
    
    // Position
    posText = strategy.position_size > 0 ? "üü¢ LONG" : strategy.position_size < 0 ? "üî¥ SHORT" : "‚ö™ FLAT"
    posColor = strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray
    table.cell(infoTable, 0, 3, "Position:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, posText, text_color=posColor, text_size=size.small)
    
    // Current P&L if in position
    if strategy.position_size != 0
        currentPnL = strategy.position_size > 0 ? ((close - longEntryPrice) / longEntryPrice) * 100 : ((shortEntryPrice - close) / shortEntryPrice) * 100
        pnlColor = currentPnL >= 0 ? color.green : color.red
        pnlText = (currentPnL >= 0 ? "+" : "") + str.tostring(currentPnL, "#.##") + "%"
        table.cell(infoTable, 0, 4, "Open P&L:", text_color=color.white, text_size=size.small)
        table.cell(infoTable, 1, 4, pnlText, text_color=pnlColor, text_size=size.small)
    else
        table.cell(infoTable, 0, 4, "Open P&L:", text_color=color.white, text_size=size.small)
        table.cell(infoTable, 1, 4, "N/A", text_color=color.gray, text_size=size.small)
    
    // Re-entries remaining
    reentriesLeft = strategy.position_size >= 0 ? maxReentries - longReentryCount : maxReentries - shortReentryCount
    table.cell(infoTable, 0, 5, "Re-entries:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, str.tostring(reentriesLeft) + " left", text_color=color.white, text_size=size.small)
    
    // Session Status
    sessionText = inEntrySession ? "üü¢ ACTIVE" : inFullSession ? "üü° NO NEW ENTRIES" : "üî¥ CLOSED"
    sessionColor = inEntrySession ? color.green : inFullSession ? color.orange : color.red
    table.cell(infoTable, 0, 6, "Session:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 6, sessionText, text_color=sessionColor, text_size=size.small)
    
    // Scaled Status
    scaledText = "N/A"
    if strategy.position_size > 0
        scaledText = longScaledIn ? "‚úÖ YES" : "‚ùå NO"
    else if strategy.position_size < 0
        scaledText = shortScaledIn ? "‚úÖ YES" : "‚ùå NO"
    table.cell(infoTable, 0, 7, "Scaled In:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 7, scaledText, text_color=color.white, text_size=size.small)

// ============================================================================
// SIGNAL LEGEND TABLE
// ============================================================================
var table legendTable = table.new(position.bottom_right, 2, 7, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(legendTable, 0, 0, "üìã SIGNAL LEGEND", text_color=color.yellow, text_size=size.tiny, bgcolor=color.new(color.gray, 60))
    table.cell(legendTable, 1, 0, "", bgcolor=color.new(color.gray, 60))
    
    table.cell(legendTable, 0, 1, "‚ñ≤", text_color=color.green, text_size=size.tiny)
    table.cell(legendTable, 1, 1, "Long Entry", text_color=color.white, text_size=size.tiny)
    
    table.cell(legendTable, 0, 2, "‚ñº", text_color=color.red, text_size=size.tiny)
    table.cell(legendTable, 1, 2, "Short Entry", text_color=color.white, text_size=size.tiny)
    
    table.cell(legendTable, 0, 3, "‚úñ", text_color=color.red, text_size=size.tiny)
    table.cell(legendTable, 1, 3, "Stop Loss", text_color=color.white, text_size=size.tiny)
    
    table.cell(legendTable, 0, 4, "‚óè", text_color=color.green, text_size=size.tiny)
    table.cell(legendTable, 1, 4, "Target 1 (50%)", text_color=color.white, text_size=size.tiny)
    
    table.cell(legendTable, 0, 5, "‚óÜ", text_color=color.lime, text_size=size.tiny)
    table.cell(legendTable, 1, 5, "Target 2 (Full)", text_color=color.white, text_size=size.tiny)
    
    table.cell(legendTable, 0, 6, "‚ñ†", text_color=color.orange, text_size=size.tiny)
    table.cell(legendTable, 1, 6, "Trailing Stop", text_color=color.white, text_size=size.tiny)

// ============================================================================
// ALERTS
// ============================================================================
// Entry Alerts
alertcondition(longCondition, title="üü¢ Long Entry", message="üü¢ LONG ENTRY on {{ticker}}\nPrice: {{close}}\nTime: {{time}}")
alertcondition(shortCondition, title="üî¥ Short Entry", message="üî¥ SHORT ENTRY on {{ticker}}\nPrice: {{close}}\nTime: {{time}}")

// Scale In Alerts
alertcondition(longScaleInCondition, title="‚ûï Long Scale In", message="‚ûï SCALE IN LONG on {{ticker}}\nPrice: {{close}}")
alertcondition(shortScaleInCondition, title="‚ûï Short Scale In", message="‚ûï SCALE IN SHORT on {{ticker}}\nPrice: {{close}}")

// Exit Alerts
alertcondition(longStopHit and not longFirstTargetHit, title="üõë Long Stop Loss", message="üõë LONG STOP LOSS on {{ticker}}\nPrice: {{close}}")
alertcondition(shortStopHit and not shortFirstTargetHit, title="üõë Short Stop Loss", message="üõë SHORT STOP LOSS on {{ticker}}\nPrice: {{close}}")

alertcondition(longFirstTargetReached, title="üéØ Long Target 1", message="üéØ LONG TARGET 1 HIT on {{ticker}}\nPrice: {{close}}\nTaking 50% profit")
alertcondition(shortFirstTargetReached, title="üéØ Short Target 1", message="üéØ SHORT TARGET 1 HIT on {{ticker}}\nPrice: {{close}}\nTaking 50% profit")

alertcondition(longSecondTargetReached, title="üéØüéØ Long Target 2", message="üéØüéØ LONG TARGET 2 HIT on {{ticker}}\nPrice: {{close}}\nFull exit")
alertcondition(shortSecondTargetReached, title="üéØüéØ Short Target 2", message="üéØüéØ SHORT TARGET 2 HIT on {{ticker}}\nPrice: {{close}}\nFull exit")

alertcondition(trailingStopLongHit, title="üî∂ Long Trailing Stop", message="üî∂ LONG TRAILING STOP on {{ticker}}\nPrice: {{close}}")
alertcondition(trailingStopShortHit, title="üî∂ Short Trailing Stop", message="üî∂ SHORT TRAILING STOP on {{ticker}}\nPrice: {{close}}")

// Bias Change Alerts
alertcondition(bullishBias and not bullishBias[1], title="üìà Bullish Bias", message="üìà BULLISH BIAS ACTIVATED on {{ticker}}")
alertcondition(bearishBias and not bearishBias[1], title="üìâ Bearish Bias", message="üìâ BEARISH BIAS ACTIVATED on {{ticker}}")

// Combined Alert for Any Entry
alertcondition(longCondition or shortCondition, title="‚ö° Any Entry Signal", message="‚ö° ENTRY SIGNAL on {{ticker}}\nPrice: {{close}}\nCheck chart for direction")

// Combined Alert for Any Exit
alertcondition(longStopHit or shortStopHit or longFirstTargetReached or shortFirstTargetReached or trailingStopLongHit or trailingStopShortHit, title="üö™ Any Exit Signal", message="üö™ EXIT SIGNAL on {{ticker}}\nPrice: {{close}}\nCheck chart for details")