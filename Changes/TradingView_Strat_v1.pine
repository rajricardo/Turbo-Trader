//@version=5
strategy("EMA Retest Strategy - Bull & Bear", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ============================================================================
// SETTINGS
// ============================================================================
// Profit target setting
useProfitTarget = input.bool(true, "Use Profit Target", group="Profit Settings")
profitTargetPercent = input.float(2.0, "Profit Target %", minval=0.1, maxval=100, step=0.1, group="Profit Settings")

// ============================================================================
// TIME SETTINGS
// ============================================================================
// Define trading session (9:30 AM to 4:00 PM EST)
tradingSession = time(timeframe.period, "0930-1600:23456", "America/New_York")
inSession = not na(tradingSession)

// Get current time in EST
currentTime = time("5", "", "America/New_York")

// Check if we're past the first 15 minutes (9:30 AM + 15 min = 9:45 AM)
sessionStart = timestamp("America/New_York", year, month, dayofmonth, 09, 30, 00)
waitPeriodEnd = sessionStart + 15 * 60 * 1000  // 15 minutes in milliseconds
pastWaitPeriod = currentTime >= waitPeriodEnd

// ============================================================================
// INDICATORS
// ============================================================================
ema9 = ta.ema(close, 9)
ema20 = ta.ema(close, 20)
vwapValue = ta.vwap(close)

// Plot indicators
plot(ema9, "9 EMA", color=color.blue, linewidth=2)
plot(ema20, "20 EMA", color=color.red, linewidth=2)
plot(vwapValue, "VWAP", color=color.orange, linewidth=2)

// ============================================================================
// FIRST CANDLE LOGIC (9:30-9:35 AM)
// ============================================================================
var bool firstCandleBullish = false
var bool firstCandleBearish = false
var bool bullishSetupActive = false
var bool bearishSetupActive = false
var float firstCandleClose = na

// Reset variables at start of new session
if inSession and not inSession[1]
    firstCandleBullish := false
    firstCandleBearish := false
    bullishSetupActive := false
    bearishSetupActive := false
    firstCandleClose := na

// Capture the first 5-minute candle (9:30-9:35 AM)
firstCandleTime = timestamp("America/New_York", year, month, dayofmonth, 09, 35, 00)
isFirstCandle = currentTime == firstCandleTime

if isFirstCandle and inSession
    firstCandleClose := close
    // Check if first candle closed above 9 EMA (BULLISH)
    if close > ema9
        firstCandleBullish := true
        bullishSetupActive := true
    // Check if first candle closed below 9 EMA (BEARISH)
    else if close < ema9
        firstCandleBearish := true
        bearishSetupActive := true

// ============================================================================
// BULLISH ENTRY CONDITIONS
// ============================================================================
// Retest from below: price touches or crosses the 9 EMA or VWAP from below
retestEMA9FromBelow = low <= ema9 and close >= ema9
retestVWAPFromBelow = low <= vwapValue and close >= vwapValue

// 9 EMA must be above VWAP for bullish setup
ema9AboveVWAP = ema9 > vwapValue

// Buy condition
buySignal = bullishSetupActive and pastWaitPeriod and inSession and (retestEMA9FromBelow or retestVWAPFromBelow) and ema9AboveVWAP and strategy.position_size == 0

// ============================================================================
// BEARISH ENTRY CONDITIONS
// ============================================================================
// Retest from below: price bounces up to touch the 9 EMA, 20 EMA, or VWAP from below but closes below 20 EMA
retestEMA9FromBelowBear = low <= ema9 and high >= ema9 and close < ema20
retestEMA20FromBelowBear = low <= ema20 and high >= ema20 and close < ema20
retestVWAPFromBelowBear = low <= vwapValue and high >= vwapValue and close < ema20

// 9 EMA must be below VWAP for bearish setup
ema9BelowVWAP = ema9 < vwapValue

// Short condition (normal or triggered by long exit)
shortSignal = bearishSetupActive and pastWaitPeriod and inSession and (retestEMA9FromBelowBear or retestEMA20FromBelowBear or retestVWAPFromBelowBear) and ema9BelowVWAP and strategy.position_size == 0

// ============================================================================
// PROFIT TARGET LOGIC
// ============================================================================
// Calculate profit percentage for current position
longProfitPercent = strategy.position_size > 0 ? ((close - strategy.position_avg_price) / strategy.position_avg_price) * 100 : 0
shortProfitPercent = strategy.position_size < 0 ? ((strategy.position_avg_price - close) / strategy.position_avg_price) * 100 : 0

// Check if profit target is hit
longProfitTargetHit = useProfitTarget and strategy.position_size > 0 and longProfitPercent >= profitTargetPercent
shortProfitTargetHit = useProfitTarget and strategy.position_size < 0 and shortProfitPercent >= profitTargetPercent

// ============================================================================
// EXIT CONDITIONS
// ============================================================================
// Close LONG when a 5-minute candle CLOSES below the 20 EMA or profit target hit
closeLongSignal = (strategy.position_size > 0 and close < ema20) or longProfitTargetHit

// Close SHORT when a 5-minute candle CLOSES above the 20 EMA or profit target hit
closeShortSignal = (strategy.position_size < 0 and close > ema20) or shortProfitTargetHit

// Trigger short immediately after closing long (but not if profit target was hit)
triggerShortAfterLongExit = closeLongSignal and not longProfitTargetHit and ema9BelowVWAP and inSession

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================
if buySignal
    strategy.entry("Long", strategy.long)
    label.new(bar_index, low, "BUY", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)

if closeLongSignal
    exitReason = longProfitTargetHit ? "Profit Target " + str.tostring(profitTargetPercent) + "%" : "Close below 20 EMA"
    strategy.close("Long", comment=exitReason)
    label.new(bar_index, high, longProfitTargetHit ? "PROFIT TARGET" : "CLOSE LONG", style=label.style_label_down, color=longProfitTargetHit ? color.green : color.orange, textcolor=color.white, size=size.small)
    // Immediately trigger short if conditions are met
    if triggerShortAfterLongExit
        strategy.entry("Short", strategy.short)
        label.new(bar_index, high, "SHORT (Auto)", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)
        bearishSetupActive := true

if shortSignal and not triggerShortAfterLongExit
    strategy.entry("Short", strategy.short)
    label.new(bar_index, high, "SHORT", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

if closeShortSignal
    exitReason = shortProfitTargetHit ? "Profit Target " + str.tostring(profitTargetPercent) + "%" : "Close above 20 EMA"
    strategy.close("Short", comment=exitReason)
    label.new(bar_index, low, shortProfitTargetHit ? "PROFIT TARGET" : "CLOSE SHORT", style=label.style_label_up, color=shortProfitTargetHit ? color.green : color.orange, textcolor=color.white, size=size.small)

// Close all positions at end of trading session
if not inSession and inSession[1]
    strategy.close_all(comment="Session End")

// ============================================================================
// VISUAL INDICATORS
// ============================================================================
// Highlight the first candle
bgcolor(isFirstCandle ? color.new(color.yellow, 90) : na, title="First Candle")

// Highlight when bullish setup is active AND 9 EMA is above VWAP
bgcolor(bullishSetupActive and ema9AboveVWAP and inSession ? color.new(color.green, 95) : na, title="Bullish Setup Active")

// Highlight when bearish setup is active AND 9 EMA is below VWAP
bgcolor(bearishSetupActive and ema9BelowVWAP and inSession ? color.new(color.red, 95) : na, title="Bearish Setup Active")

// Highlight when setup is active but EMA/VWAP condition not met
bgcolor((bullishSetupActive and not ema9AboveVWAP and inSession) or (bearishSetupActive and not ema9BelowVWAP and inSession) ? color.new(color.gray, 95) : na, title="Setup Active but Condition Not Met")

// Display current profit percentage on chart
if strategy.position_size != 0
    profitText = strategy.position_size > 0 ? "Long P/L: " + str.tostring(longProfitPercent, "#.##") + "%" : "Short P/L: " + str.tostring(shortProfitPercent, "#.##") + "%"
    profitColor = (strategy.position_size > 0 and longProfitPercent > 0) or (strategy.position_size < 0 and shortProfitPercent > 0) ? color.green : color.red
    var table profitTable = table.new(position.top_right, 1, 1)
    table.cell(profitTable, 0, 0, profitText, bgcolor=color.new(profitColor, 80), text_color=color.white, text_size=size.normal)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(buySignal, title="Buy Signal", message="Buy Signal: Retest of EMA9 or VWAP from below (EMA9 > VWAP)")
alertcondition(shortSignal, title="Short Signal", message="Short Signal: Retest of EMA9, EMA20, or VWAP from below, closes below 20 EMA (EMA9 < VWAP)")
alertcondition(closeLongSignal, title="Close Long", message="Close Long: Close below 20 EMA or Profit Target Hit")
alertcondition(closeShortSignal, title="Close Short", message="Close Short: Close above 20 EMA or Profit Target Hit")
alertcondition(triggerShortAfterLongExit, title="Auto Short After Long Exit", message="Auto Short: Triggered immediately after closing long position")
alertcondition(longProfitTargetHit, title="Long Profit Target Hit", message="Long Profit Target Hit")
alertcondition(shortProfitTargetHit, title="Short Profit Target Hit", message="Short Profit Target Hit")